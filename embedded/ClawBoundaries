/*
  Claw Control by Percentage
  0%   = Fully Open (Position 2861)
  100% = Fully Closed (Position 1620)
*/
#include <Adafruit_NeoPixel.h>
#include <SCServo.h>

#define PIN        48 
#define NUMPIXELS  1 

// --- CONFIGURATION ---
// Based on your comments: "absolute min: 1620 absolute max: 2861"
// You requested: 0% = Max Value, 100% = Min Value
const int POS_0_PERCENT   = 2861; 
const int POS_100_PERCENT = 1620; 

SMS_STS st;
Adafruit_NeoPixel pixels(NUMPIXELS, PIN, NEO_GRB + NEO_KHZ800);

// GPIO 18 - S_RXD, GPIO 19 - S_TXD, as default.
#define S_RXD 44
#define S_TXD 43

void setup()
{
  Serial.begin(115200);   // For computer screen (Debug)
  Serial1.begin(1000000, SERIAL_8N1, S_RXD, S_TXD); // For Servo communication
  st.pSerial = &Serial1;
  delay(1000);
  pixels.begin();
}

// --- NEW HELPER FUNCTION ---
// Call this function with a value between 0 and 100
void moveClawToPercent(int percent) {
  
  // 1. Safety: limit input to 0-100
  percent = constrain(percent, 0, 100);

  // 2. Math: Map 0-100 to 2861-1620
  // map(value, in_min, in_max, out_min, out_max)
  int targetPos = map(percent, 0, 100, POS_0_PERCENT, POS_100_PERCENT);

  // 3. Command the Servo
  Serial1.print("Moving to ");
  Serial1.print(percent);
  Serial1.print("% -> Position: ");
  Serial1.println(targetPos);
  
  st.WritePosEx(6, targetPos, 1500, 50);
}

void loop()
{
  // --- EXAMPLE 1: Set to 5% (Should go to 2861) ---
  moveClawToPercent(5); 
  delay(1000); // Wait for move to finish

  // Check Position
  int currentPos = st.ReadPos(6);
  if(currentPos != -1){
    Serial1.print("Current Pos: "); 
    Serial1.println(currentPos);
  } else {
    Serial1.println("Read Failed (-1)");
  }

  // --- EXAMPLE 2: Set to 99% (Should go to 1620) ---
  moveClawToPercent(99); 
  delay(1000);

  // Check Position
  currentPos = st.ReadPos(6);
  if(currentPos != -1){
    Serial1.print("Current Pos: ");
    Serial1.println(currentPos);
  }

  // --- EXAMPLE 3: Set to 50% (Halfway) ---
  moveClawToPercent(50); 
  delay(1000);

  // Check Position
  currentPos = st.ReadPos(6);
  if(currentPos != -1){
    Serial1.print("Current Pos: ");
    Serial1.println(currentPos);
  }
  

   // --- EXAMPLE 3: Set to 25% (Halfway) ---
  moveClawToPercent(25); 
  delay(1000);

  // Check Position
  currentPos = st.ReadPos(6);
  if(currentPos != -1){
    Serial1.print("Current Pos: ");
    Serial1.println(currentPos);
  }

   // --- EXAMPLE 3: Set to 75% (Halfway) ---
  moveClawToPercent(75); 
  delay(1000);

  // Check Position
  currentPos = st.ReadPos(6);
  if(currentPos != -1){
    Serial1.print("Current Pos: ");
    Serial1.println(currentPos);
  }

  // LED Status
  pixels.setPixelColor(0, pixels.Color(0, 150, 150));
  pixels.show();
  Serial.println("Loop Complete");
  delay(1000);
  pixels.clear();
  pixels.show();
}
